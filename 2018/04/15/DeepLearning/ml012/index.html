<!DOCTYPE html><html prefix="og: http://ogp.me/ns#"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>케라스맛 Chapter4] 케라스로 구현하는 CNN (합성곱신경망) · ddulh's</title><meta name="description" content="잡념"><meta name="og:title" content="케라스맛 Chapter4] 케라스로 구현하는 CNN (합성곱신경망)"><meta name="og:type" content="website"><meta name="og:url" content="https://ddulhddul.github.io/2018/04/15/DeepLearning/ml012/"><meta name="og:image" content="http://image.toast.com/aaaaahq/hola_cover.JPG"><meta name="og:description" content="잡념"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/chiangmai.css"><meta name="steem:author" content="@stunstunstun"><meta name="fb:app_id" content="1258629384258634"><link rel="search" type="application/opensearchdescription+xml" href="https://ddulhddul.github.io/atom.xml" title="ddulh's"></head><body class="post"><div id="fb-root"></div><div class="wrap"><header><nav class="navi-post"><a class="navi-post-back" href="javascript:history.back()"><i class="fa fa-arrow-left" aria-hidden="true"></i></a><a class="navi-post-home" href="/"><i class="fa fa-home" aria-hidden="true"></i></a></nav></header><main class="post"><div class="post"><article class="post-block"><h1 class="post-title">케라스맛 Chapter4] 케라스로 구현하는 CNN (합성곱신경망)</h1><div class="post-info"><div class="post-info-profile"><a href="https://github.com/stunstunstun" target="_blank"><img src="/image/profile.jpg"></a></div><div class="post-info-details"><div class="post-categories"><a href="/categories/DeepLearning" target="_self"><span>DEEPLEARNING</span></a></div><div class="post-date">Apr 15, 2018</div></div></div><div class="post-share"><div class="fb-like" data-href="https://ddulhddul.github.io/2018/04/15/DeepLearning/ml012/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false">                 </div><div class="fb-share-button" data-href="https://ddulhddul.github.io/2018/04/15/DeepLearning/ml012/" data-layout="button" data-size="small" data-mobile-iframe="true"></div><div class="fb-follow" data-href="https://www.facebook.com/holaxprogramming/" data-layout="button_count" data-size="small" data-show-faces="true"></div></div><div class="post-content"><blockquote>
<p>영상처리에 많이 활용되는 합성곱을 이용하는 인공신경망 기술.</p>
</blockquote>
<h1 id="4-1-CNN-원리"><a href="#4-1-CNN-원리" class="headerlink" title="4.1 CNN 원리"></a>4.1 CNN 원리</h1><ul>
<li><p>합성곱 필터를 이용해 신경망 동작을 수행.</p>
<ul>
<li>합성곱계층 : 특징점을 효과적으로 찾는데 활용.</li>
<li>완전연결계층 : 찾으나 특징점을 기반으로 이미지를 분류하는데 주로 활용.<blockquote>
<p>주 목적은 그렇지만… 스스로 학습해 신경망이 최적화되기 때문에 그역할이 적정하게 둘에 분배된다. 한쪽이 절대적으로 특정 역할을 하는게 아니다.</p>
</blockquote>
</li>
</ul>
</li>
<li><p>CNN과 DNN 비교</p>
<ul>
<li>DNN은 이미지를 1차원 벡터로 변환하여 처리하기 때문에 2차원 특성을 처리하기엔 한계가 있다.</li>
<li>반면 CNN은 2차원 이상의 데이터 처리에 적합하다. </li>
<li>CNN 은 이미지의 높이와 넓이를 생각하며 2차원 처리를 수행.</li>
</ul>
</li>
<li><p>CNN 은 합성곱 계층이 끝나면 맥스풀링 계층을 이용해 각 지역별로 최댓값을 찾아줘서 특징점 위치가 약간씩 달라져도 딥러닝을 제대로 수행한다.</p>
</li>
</ul>
<h1 id="4-2-필기체를-분류하는-CNN-구현"><a href="#4-2-필기체를-분류하는-CNN-구현" class="headerlink" title="4.2 필기체를 분류하는 CNN 구현"></a>4.2 필기체를 분류하는 CNN 구현</h1><ul>
<li>4.2.1 분류 CNN 모델링</li>
<li>4.2.2 분류 CNN을 위한 데이터 준비  </li>
<li>4.2.3 학습 효과 분석</li>
<li>4.2.3 분류 CNN 학습 및 테스트</li>
</ul>
<h2 id="4-2-1-분류-CNN-모델링"><a href="#4-2-1-분류-CNN-모델링" class="headerlink" title="4.2.1 분류 CNN 모델링"></a>4.2.1 분류 CNN 모델링</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="comment"># 분류 CNN 모델링</span></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> models, layers</span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> backend <span class="comment"># 딥러닝 엔진들 함수를 직접 호출하거나 주요 파라미터 제어</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CNN</span><span class="params">(models.Sequential)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, input_shape, num_classes)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 3X3 커널 32개로 구성된 합성곱 계층</span></span><br><span class="line">        self.add(layers.Conv2D(<span class="number">32</span>, kernel_size=(<span class="number">3</span>, <span class="number">3</span>),</span><br><span class="line">                 activation=<span class="string">'relu'</span>,</span><br><span class="line">                 input_shape=input_shape))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 64커널수, Maxpooling 이 부속계층으로 있음. (가중치가 바뀌진 않지만 특정한 형태로 변화시키는 계층을 부속계층이라고 한다고 합니다)</span></span><br><span class="line">        self.add(layers.Conv2D(<span class="number">64</span>, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">'relu'</span>))</span><br><span class="line">        self.add(layers.MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>)))</span><br><span class="line">        self.add(layers.Dropout(<span class="number">0.25</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 완전연결계층. Flatten : 2차원 이미지를 1차원으로 변화시킴</span></span><br><span class="line">        self.add(layers.Flatten())</span><br><span class="line">        self.add(layers.Dense(<span class="number">128</span>, activation=<span class="string">'relu'</span>))</span><br><span class="line">        self.add(layers.Dropout(<span class="number">0.5</span>))</span><br><span class="line">        self.add(layers.Dense(num_classes, activation=<span class="string">'softmax'</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 컴파일</span></span><br><span class="line">        self.compile(loss=keras.losses.categorical_crossentropy,</span><br><span class="line">                      optimizer=<span class="string">'rmsprop'</span>,</span><br><span class="line">                      metrics=[<span class="string">'accuracy'</span>])</span><br></pre></td></tr></table></figure>
<h2 id="4-2-2-분류-CNN을-위한-데이터-준비"><a href="#4-2-2-분류-CNN을-위한-데이터-준비" class="headerlink" title="4.2.2 분류 CNN을 위한 데이터 준비"></a>4.2.2 분류 CNN을 위한 데이터 준비</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="comment"># 분류 CNN을 위한 데이터 준비  </span></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> datasets </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DATA</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        num_classes = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">        (x_train, y_train), (x_test, y_test) = datasets.mnist.load_data()</span><br><span class="line">        img_rows, img_cols = x_train.shape[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 흑백 이미지는 채널 정보가 존재하지 않아서, 추가적인 차원을 이미지 데이터에 포함하는 작업.</span></span><br><span class="line">        <span class="keyword">if</span> backend.image_data_format() == <span class="string">'channels_first'</span>:</span><br><span class="line">            <span class="comment"># 샘플수, 채널수, 이미지 가로길이, 이미지세로길이</span></span><br><span class="line">            x_train = x_train.reshape(x_train.shape[<span class="number">0</span>], <span class="number">1</span>, img_rows, img_cols)</span><br><span class="line">            x_test = x_test.reshape(x_test.shape[<span class="number">0</span>], <span class="number">1</span>, img_rows, img_cols)</span><br><span class="line">            input_shape = (<span class="number">1</span>, img_rows, img_cols)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 샘플수, 이미지 가로길이, 이미지세로길이, 채널수</span></span><br><span class="line">            x_train = x_train.reshape(x_train.shape[<span class="number">0</span>], img_rows, img_cols, <span class="number">1</span>)</span><br><span class="line">            x_test = x_test.reshape(x_test.shape[<span class="number">0</span>], img_rows, img_cols, <span class="number">1</span>)</span><br><span class="line">            input_shape = (img_rows, img_cols, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        x_train = x_train.astype(<span class="string">'float32'</span>)</span><br><span class="line">        x_test = x_test.astype(<span class="string">'float32'</span>)</span><br><span class="line">        x_train /= <span class="number">255</span></span><br><span class="line">        x_test /= <span class="number">255</span></span><br><span class="line"></span><br><span class="line">        y_train = keras.utils.to_categorical(y_train, num_classes)</span><br><span class="line">        y_test = keras.utils.to_categorical(y_test, num_classes)</span><br><span class="line">        </span><br><span class="line">        self.input_shape = input_shape</span><br><span class="line">        self.num_classes = num_classes</span><br><span class="line">        self.x_train, self.y_train = x_train, y_train</span><br><span class="line">        self.x_test, self.y_test = x_test, y_test</span><br></pre></td></tr></table></figure>
<h2 id="4-2-3-학습-효과-분석"><a href="#4-2-3-학습-효과-분석" class="headerlink" title="4.2.3 학습 효과 분석"></a>4.2.3 학습 효과 분석</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="comment"># 학습 효과 분석</span></span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="keyword">from</span> keraspp.skeras <span class="keyword">import</span> plot_loss, plot_acc</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br></pre></td></tr></table></figure>
<h2 id="4-2-3-분류-CNN-학습-및-테스트"><a href="#4-2-3-분류-CNN-학습-및-테스트" class="headerlink" title="4.2.3 분류 CNN 학습 및 테스트"></a>4.2.3 분류 CNN 학습 및 테스트</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="comment"># 분류 CNN 학습 및 테스트</span></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 1회 학습시 입력 데이터를 128개씩 나눠서 입력.</span></span><br><span class="line">    batch_size = <span class="number">128</span></span><br><span class="line">    epochs = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    data = DATA()</span><br><span class="line">    model = CNN(data.input_shape, data.num_classes)</span><br><span class="line"></span><br><span class="line">    history = model.fit(data.x_train, data.y_train,</span><br><span class="line">              batch_size=batch_size,</span><br><span class="line">              epochs=epochs,</span><br><span class="line">              <span class="comment"># 검증용 데이터는 학습데이터의 일부를 사용</span></span><br><span class="line">              validation_split=<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">    score = model.evaluate(data.x_test, data.y_test)</span><br><span class="line">    print()</span><br><span class="line">    print(<span class="string">'Test loss:'</span>, score[<span class="number">0</span>])</span><br><span class="line">    print(<span class="string">'Test accuracy:'</span>, score[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    plot_loss(history)</span><br><span class="line">    plt.show()</span><br><span class="line">    plot_acc(history)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="http-localhost-8888-notebooks-nb-ex4-1-cnn-mnist-cl-ipynb"><a href="#http-localhost-8888-notebooks-nb-ex4-1-cnn-mnist-cl-ipynb" class="headerlink" title="http://localhost:8888/notebooks/nb_ex4_1_cnn_mnist_cl.ipynb"></a><a href="http://localhost:8888/notebooks/nb_ex4_1_cnn_mnist_cl.ipynb" target="_blank" rel="noopener">http://localhost:8888/notebooks/nb_ex4_1_cnn_mnist_cl.ipynb</a></h2><h1 id="4-3-컬러-이미지를-분류하는-CNN-구현"><a href="#4-3-컬러-이미지를-분류하는-CNN-구현" class="headerlink" title="4.3 컬러 이미지를 분류하는 CNN 구현"></a>4.3 컬러 이미지를 분류하는 CNN 구현</h1><ul>
<li>필기체 분류와 크게 다르지 않다.</li>
<li>CIFAR-10<ul>
<li>4.3.1 분류 CNN 패키지 임포트</li>
<li>4.3.2 분류 CNN 모델링</li>
<li>4.3.3 분류 CNN을 위한 데이터 준비</li>
<li>4.3.4 분류 CNN의 학습 및 성능 평가를 위한 머신 클래스 구현</li>
<li>4.3.5 분류 CNN의 학습 및 성능 평가 수행</li>
</ul>
</li>
</ul>
<h2 id="4-3-1-분류-CNN-패키지-임포트"><a href="#4-3-1-분류-CNN-패키지-임포트" class="headerlink" title="4.3.1 분류 CNN 패키지 임포트"></a>4.3.1 분류 CNN 패키지 임포트</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> model_selection, metrics</span><br><span class="line"><span class="comment"># 지정한 최대 최소값을 이용해 입력값 크기 조정</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 케라스 모델링을 위한 서브패키지들</span></span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> backend <span class="keyword">as</span> K</span><br><span class="line"><span class="keyword">from</span> keras.utils <span class="keyword">import</span> np_utils</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Input, Conv2D, MaxPooling2D, Flatten, Dense, Dropout</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> skeras</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> sfile</span><br></pre></td></tr></table></figure>
<h2 id="4-3-2-분류-CNN-모델링"><a href="#4-3-2-분류-CNN-모델링" class="headerlink" title="4.3.2 분류 CNN 모델링"></a>4.3.2 분류 CNN 모델링</h2><ul>
<li>LeNet 신경망 모델 사용<ul>
<li>합성곱 계층 2개, 완전연결계층 1개</li>
<li>Conv2D(), Maxpoling2D() : 채널에 처리가 있는 계층</li>
<li>Dense() : 채널에 대한 처리가 없는 계층</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CNN</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(model, nb_classes, in_shape=None)</span>:</span></span><br><span class="line">        model.nb_classes = nb_classes</span><br><span class="line">        model.in_shape = in_shape</span><br><span class="line">        model.build_model()</span><br><span class="line">        super().__init__(model.x, model.y)</span><br><span class="line">        model.compile()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_model</span><span class="params">(model)</span>:</span></span><br><span class="line">        nb_classes = model.nb_classes</span><br><span class="line">        in_shape = model.in_shape</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 주어진 입력 이미지의 크기를 처리하는 입력 계층을 정의</span></span><br><span class="line">        x = Input(in_shape)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 합성곱 계층 두 개를 정의</span></span><br><span class="line">        h = Conv2D(<span class="number">32</span>, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">'relu'</span>,</span><br><span class="line">                   input_shape=in_shape)(x)</span><br><span class="line">        h = Conv2D(<span class="number">64</span>, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">'relu'</span>)(h)</span><br><span class="line"></span><br><span class="line">        h = MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>))(h) <span class="comment"># 가로세로 두 축으로 반반씩 줄어듬</span></span><br><span class="line">        h = Dropout(<span class="number">0.25</span>)(h)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 합성곱 계층을 완전연결 계층으롤 보내기 위해 플랫턴 작업</span></span><br><span class="line">        <span class="comment"># 3차원 데이터 -&gt; 1차원</span></span><br><span class="line">        h = Flatten()(h)</span><br><span class="line">        z_cl = h</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 완전연결계층의 은닉 계층과 출력 계층</span></span><br><span class="line">        h = Dense(<span class="number">128</span>, activation=<span class="string">'relu'</span>)(h)</span><br><span class="line">        h = Dropout(<span class="number">0.5</span>)(h)</span><br><span class="line">        z_fl = h</span><br><span class="line">        y = Dense(nb_classes, activation=<span class="string">'softmax'</span>, name=<span class="string">'preds'</span>)(h)</span><br><span class="line"></span><br><span class="line">        model.cl_part = Model(x, z_cl)</span><br><span class="line">        model.fl_part = Model(x, z_fl)</span><br><span class="line"></span><br><span class="line">        model.x, model.y = x, y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">compile</span><span class="params">(model)</span>:</span></span><br><span class="line">        Model.compile(model, loss=<span class="string">'categorical_crossentropy'</span>,</span><br><span class="line">                      optimizer=<span class="string">'adadelta'</span>, metrics=[<span class="string">'accuracy'</span>])</span><br></pre></td></tr></table></figure>
<h2 id="4-3-3-분류-CNN을-위한-데이터-준비"><a href="#4-3-3-분류-CNN을-위한-데이터-준비" class="headerlink" title="4.3.3 분류 CNN을 위한 데이터 준비"></a>4.3.3 분류 CNN을 위한 데이터 준비</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 데이터를 머신러닝에 사용하기 적합하도록 조정하는 역할</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataSet</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, X, y, nb_classes, scaling=True, test_size=<span class="number">0.2</span>, random_state=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        X is originally vector. Hence, it will be transformed</span></span><br><span class="line"><span class="string">        to 2D images with a channel (i.e, 3D).</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.X = X</span><br><span class="line">        self.add_channels()</span><br><span class="line"></span><br><span class="line">        X = self.X</span><br><span class="line">        <span class="comment"># the data, shuffled and split between train and test sets</span></span><br><span class="line">        X_train, X_test, y_train, y_test = model_selection.train_test_split(</span><br><span class="line">            X, y, test_size=<span class="number">0.2</span>, random_state=random_state)</span><br><span class="line"></span><br><span class="line">        print(X_train.shape, y_train.shape)</span><br><span class="line"></span><br><span class="line">        X_train = X_train.astype(<span class="string">'float32'</span>)</span><br><span class="line">        X_test = X_test.astype(<span class="string">'float32'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> scaling:</span><br><span class="line">            <span class="comment"># scaling to have (0, 1) for each feature (each pixel)</span></span><br><span class="line">            scaler = MinMaxScaler()</span><br><span class="line">            n = X_train.shape[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># 스케일링 기준은 X_train 으로만 해야한다. X_test는 X_train으로부터 정해진 기준을 따르게 한다.</span></span><br><span class="line">            X_train = scaler.fit_transform(</span><br><span class="line">                X_train.reshape(n, <span class="number">-1</span>)).reshape(X_train.shape)</span><br><span class="line">            n = X_test.shape[<span class="number">0</span>]</span><br><span class="line">            X_test = scaler.transform(</span><br><span class="line">                X_test.reshape(n, <span class="number">-1</span>)).reshape(X_test.shape)</span><br><span class="line">            self.scaler = scaler</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'X_train shape:'</span>, X_train.shape)</span><br><span class="line">        print(X_train.shape[<span class="number">0</span>], <span class="string">'train samples'</span>)</span><br><span class="line">        print(X_test.shape[<span class="number">0</span>], <span class="string">'test samples'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># convert class vectors to binary class matrices</span></span><br><span class="line">        Y_train = np_utils.to_categorical(y_train, nb_classes)</span><br><span class="line">        Y_test = np_utils.to_categorical(y_test, nb_classes)</span><br><span class="line"></span><br><span class="line">        self.X_train, self.X_test = X_train, X_test</span><br><span class="line">        self.Y_train, self.Y_test = Y_train, Y_test</span><br><span class="line">        self.y_train, self.y_test = y_train, y_test</span><br><span class="line">        <span class="comment"># self.input_shape = input_shape</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 채널 정보를 데이터에 포함시키는 과정</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_channels</span><span class="params">(self)</span>:</span></span><br><span class="line">        X = self.X</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 흑백 이미지인지 검사</span></span><br><span class="line">        <span class="keyword">if</span> len(X.shape) == <span class="number">3</span>:</span><br><span class="line">            N, img_rows, img_cols = X.shape</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> K.image_dim_ordering() == <span class="string">'th'</span>:</span><br><span class="line">                X = X.reshape(X.shape[<span class="number">0</span>], <span class="number">1</span>, img_rows, img_cols)</span><br><span class="line">                input_shape = (<span class="number">1</span>, img_rows, img_cols)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                X = X.reshape(X.shape[<span class="number">0</span>], img_rows, img_cols, <span class="number">1</span>)</span><br><span class="line">                input_shape = (img_rows, img_cols, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            input_shape = X.shape[<span class="number">1</span>:]  <span class="comment"># channel is already included.</span></span><br><span class="line"></span><br><span class="line">        self.X = X</span><br><span class="line">        self.input_shape = input_shape</span><br></pre></td></tr></table></figure>
<h2 id="4-3-4-분류-CNN의-학습-및-성능-평가를-위한-머신-클래스-구현"><a href="#4-3-4-분류-CNN의-학습-및-성능-평가를-위한-머신-클래스-구현" class="headerlink" title="4.3.4 분류 CNN의 학습 및 성능 평가를 위한 머신 클래스 구현"></a>4.3.4 분류 CNN의 학습 및 성능 평가를 위한 머신 클래스 구현</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 학습 및 성능 평가 코드가 들어 있는 클래스</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Machine</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, X, y, nb_classes=<span class="number">2</span>, fig=True)</span>:</span></span><br><span class="line">        self.nb_classes = nb_classes</span><br><span class="line">        self.set_data(X, y)</span><br><span class="line">        self.set_model()</span><br><span class="line">        <span class="comment"># 수행결과를 그림으로 보여줄지</span></span><br><span class="line">        self.fig = fig</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_data</span><span class="params">(self, X, y)</span>:</span></span><br><span class="line">        nb_classes = self.nb_classes</span><br><span class="line">        self.data = DataSet(X, y, nb_classes)</span><br><span class="line">        print(<span class="string">'data.input_shape'</span>, self.data.input_shape)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_model</span><span class="params">(self)</span>:</span></span><br><span class="line">        nb_classes = self.nb_classes</span><br><span class="line">        data = self.data</span><br><span class="line">        self.model = CNN(nb_classes=nb_classes, in_shape=data.input_shape)</span><br><span class="line">        <span class="comment"># cnn_lenet(nb_classes=nb_classes, in_shape=data.input_shape)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fit</span><span class="params">(self, </span></span></span><br><span class="line"><span class="function"><span class="params">            epochs=<span class="number">10</span>,      # 에포크</span></span></span><br><span class="line"><span class="function"><span class="params">            batch_size=<span class="number">128</span>, # 학습시 한번에 처리할 블록 길이</span></span></span><br><span class="line"><span class="function"><span class="params">            verbose=<span class="number">1</span>       # 화면에 진행사항 표시방법</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span>:</span></span><br><span class="line">        data = self.data</span><br><span class="line">        model = self.model</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 학습 시작</span></span><br><span class="line">        history = model.fit(data.X_train, data.Y_train, batch_size=batch_size, epochs=epochs,</span><br><span class="line">                            verbose=verbose, validation_data=(data.X_test, data.Y_test))</span><br><span class="line">        <span class="keyword">return</span> history</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 학습과 성능 평가 전체를 진행</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, epochs=<span class="number">10</span>, batch_size=<span class="number">128</span>, verbose=<span class="number">1</span>)</span>:</span></span><br><span class="line">        data = self.data</span><br><span class="line">        model = self.model</span><br><span class="line">        fig = self.fig</span><br><span class="line"></span><br><span class="line">        history = self.fit(epochs=epochs,</span><br><span class="line">                           batch_size=batch_size, verbose=verbose)</span><br><span class="line"></span><br><span class="line">        score = model.evaluate(data.X_test, data.Y_test, verbose=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Confusion matrix'</span>)</span><br><span class="line">        Y_test_pred = model.predict(data.X_test, verbose=<span class="number">0</span>)</span><br><span class="line">        y_test_pred = np.argmax(Y_test_pred, axis=<span class="number">1</span>)</span><br><span class="line">        print(metrics.confusion_matrix(data.y_test, y_test_pred))</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Test score:'</span>, score[<span class="number">0</span>])</span><br><span class="line">        print(<span class="string">'Test accuracy:'</span>, score[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Save results</span></span><br><span class="line">        suffix = sfile.unique_filename(<span class="string">'datatime'</span>)</span><br><span class="line">        foldname = <span class="string">'output_'</span> + suffix</span><br><span class="line">        os.makedirs(foldname)</span><br><span class="line">        skeras.save_history_history(</span><br><span class="line">            <span class="string">'history_history.npy'</span>, history.history, fold=foldname)</span><br><span class="line">        model.save_weights(os.path.join(foldname, <span class="string">'dl_model.h5'</span>))</span><br><span class="line">        print(<span class="string">'Output results are saved in'</span>, foldname)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 학습 곡선 그리기</span></span><br><span class="line">        <span class="keyword">if</span> fig:</span><br><span class="line">            plt.figure(figsize=(<span class="number">12</span>, <span class="number">4</span>))</span><br><span class="line">            plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">            skeras.plot_acc(history)</span><br><span class="line">            plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">            skeras.plot_loss(history)</span><br><span class="line">            plt.show()</span><br><span class="line"></span><br><span class="line">        self.history = history</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> foldname</span><br></pre></td></tr></table></figure>
<h2 id="4-3-5-분류-CNN의-학습-및-성능-평가-수행"><a href="#4-3-5-분류-CNN의-학습-및-성능-평가-수행" class="headerlink" title="4.3.5 분류 CNN의 학습 및 성능 평가 수행"></a>4.3.5 분류 CNN의 학습 및 성능 평가 수행</h2><h2 id="http-localhost-8888-notebooks-nb-ex4-2-cnn-cifar10-cl-ipynb"><a href="#http-localhost-8888-notebooks-nb-ex4-2-cnn-cifar10-cl-ipynb" class="headerlink" title="http://localhost:8888/notebooks/nb_ex4_2_cnn_cifar10_cl.ipynb"></a><a href="http://localhost:8888/notebooks/nb_ex4_2_cnn_cifar10_cl.ipynb" target="_blank" rel="noopener">http://localhost:8888/notebooks/nb_ex4_2_cnn_cifar10_cl.ipynb</a></h2><h1 id="4-4-마치며"><a href="#4-4-마치며" class="headerlink" title="4.4 마치며"></a>4.4 마치며</h1><ul>
<li>CNN 은 합성곱 계층을 이용해 적은 가중치 수로도 이미지 분류에서 높은 성능(?)을 낸다.</li>
<li>가중치 수가 적기 때문에 과적합의 가능성도 낮아진다.</li>
<li>이미지 특성에 맞게 합성곱 필터링이 이루어지기 때문에 이미지 내에 있는 특징점을 잘 찾아낸다.</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2018/04/01/DeepLearning/ml011/"><i class="fa fa-arrow-left" aria-hidden="true"></i></a><a class="next" href="/2018/05/04/DeepLearning/ml027/"><i class="fa fa-arrow-right" aria-hidden="true"></i></a></div><ins class="adsbygoogle adsense-bottom" style="display:block" data-ad-client="ca-pub-6188640546219653" data-ad-slot="6129396565" data-ad-format="auto"></ins><div class="fb-comments-area"><div class="fb-comments" data-href="https://ddulhddul.github.io/2018/04/15/DeepLearning/ml012/" data-width="700" data-numposts="5"></div></div><div class="copyright"><p>© 2012 - 2021 <a href="https://github.com/stunstunstun" target="_blank">Minhyeok Jung</a>. Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/stunstunstun/hexo-theme-chiangmai" target="_blank">hexo-theme-chiangmai</a>.</p></div></footer></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({});</script><script>window.fbAsyncInit=function(){FB.init({appId:"1258629384258634",cookie:!0,xfbml:!0,version:"v2.8"}),FB.AppEvents.logPageView()},function(e,n,t){var o,c=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="//connect.facebook.net/en_US/sdk.js",c.parentNode.insertBefore(o,c))}(document,"script","facebook-jssdk");</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create','UA-97419941-1','auto');ga('send','pageview');</script></body></html>